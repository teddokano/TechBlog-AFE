#産業用途向けアナログ・フロントエンド：NAFEシリーズ

# アナログ・フロントエンド(AFE)って？

アナログ・フロントエンド（以下AFE: Analog Front End）は，マイコンやプロセッサを用いるシステムにおいて，アナログとデジタルの橋渡しをする部分を指します．
このAFEにはアナログ信号の入力だけを行うもの，出力だけを行うもの，またはその両方を行うものもあります．

#### 様々なAFE:
たとえばオーディオ・システムでは，マイクからのアナログ音声信号を処理・記録可能なデジタル信号に変換し，またはそのデジタル信号をスピーカやイヤホンで鳴らすことが可能なアナログ信号に変換する部分にあたります(一般にコーデック(Codec)と呼ばれるチップで実現されることが多い)．  
バッテリ管理システム(BMS)ではマイコンやプロセッサが充放電制御を行いますが，バッテリの電圧や電流などのアナログ値を測定する部分としてAFE部分が存在します．  
これらの用途にはその特性に合わせた専用のAFEが使われます．主要機能としてアナログからデジタルへの変換(ADC: Analog-to-Digital Converter)やデジタルからアナログへの変換(DAC: Digital-to-Analog Conveter)が含まれ，これに入出力信号特性に合わせた前段や後段のフィルタや増幅器も含まれます．

#### 産業用途向けAFE:
一般に産業用途では工場のラインやプロセス管理などで高精度のアナログ信号の測定が必要になります．またバルブの制御のためにアナログ信号の出力が必要になる場合もあります．　　
産業用AFEのアナログ入力は熱電対(Thermocouple)や測温抵抗体(RTD)のような温度センサ，ロードセルのような力・圧力センサなどの様々なセンサに接続されます．
また純粋に電圧や電流を測定するためにアナログ入力が使われる場合もあります．  

#### 特性に合わせた回路が必要:
たとえば温度センサの熱電対では非常に小さな電圧を出力するため，高精度で低ノイズの増幅器が必要になります．　　
また温度センサのRTDは抵抗値が変化するため，その抵抗値を測定するために一定の電流(励起電流という)を流し，そのときの電圧を測定する方法が一般的です．  
ただし大きな励起電流を流すとRTDが発熱してしまい，正しい温度測定ができなくなるため微弱な励起電流しか使えません．微弱な励起電流では微小な電圧しか発生させられないため高精度で低ノイズの増幅器が，励起のための精密な定電流源とともに必要になります．　　
力を計測するロードセルでは，励起電圧をかけた素子で小さな電圧変化を検出します．このため高精度で低ノイズの増幅器が必要になります．
電圧や電流の測定では，その測定対象に合わせた入力レンジへの調整が行われます．

これまでの産業用AFEは，これらのセンサや測定の対象となる出力の特性がそれぞれ異なるため，それぞれの特性に合わせた個別の回路を設けて対応してきました．  

#### ユニバーサル入力という考え方
測定対象ごとに入力回路を備えた機器を用意するのは非効率的です．その都度，専用のハードウェアを開発し，ラインナップを揃え，各種類の在庫を管理しなければなりません．
これらを共通化できれば，上記の問題は一気に解決します．
NXPのAFEでは入力を「ユニバーサル化」することが可能です．
+/-12.5Vのシングルエンド入力を最大8本(差動入力では+/-25Vを4ライン)備え，内部PGA(Programmable Gain Amp)を0.2倍〜16倍で設定可能．さらに内部励起電圧・電流源を任意の入力ピンから出力可能．   
このようなチップを用いれば，最低限の外付け回路だけを持つ基板を用意しておき，測定対象はソフトウェアで切り替えて対応することが可能になります．  
NXPのAFEは入力保護機能もチップに内蔵しているため，外付け部品は最低限で済み，測定精度に影響を与える保護ダイオードの追加も不要としています．  

# NAFE13388
では具体例として低消費電力型AFE，NAFE13388を例にその特長を見てみましょう．  

## ADC
NAFE13388は産業用アナログ入力機器に最適なアナログ・フロントエンドチップです．
ADコンバータは3次のΣΔ変調器と各種設定が可能なSINCフィルタで構成されています．NAFE13388では17ビット分のENOBを得る場合，72kHzのサンプルレートに設定します．高速版のNAFE73388を使えば，同ENOBをが得られるサンプルレートは144kHzとなります．

AD変換に必要な高精度基準電圧源を内蔵しているため，外部基準電圧は不要．温度補正ループにより，動作温度範囲内で0.000xxxx%精度を実現しています．  
ADコンバータの前段には0.2倍〜16倍に設定可能なPGAを配置．シングルエンド入力でのフルスケール・レンジとして+/-12.5V(PGAゲイン:0.2倍時)〜+/-0.15625V(PGAゲイン:16倍時)に対応します．  

## 励起電圧・電流源
入力はシングルエンドで最大8入力が可能なピンが用意されており，内蔵マルチプレクサの設定によりシングルエンドや差動，さらに励起電圧・電流出力の適用も可能にしています．  
励起電圧・電流は+/-6mV〜+/-12V，+/-977nA〜+/-2mAに設定でき，任意の入力ピンに出力が可能です．  

## 論理チャンネル
入力ピンの選択(任意をピンをシングルエンドや差動入力として指定)，励起電圧・電流と出力ピンの選択，PGAゲイン，サンプリング周波数/後段SINCフィルタ，温度補正ループのON/OFFなどの設定は，ひとまとめにして管理できます．  
この管理の単位を論理チャンネルと呼び，最大16の論理チャンネルを設定しておくことができます．  
16の論理チャンネルはそれぞれ個別に管理，有効化，無効化できます．

# 測定コマンド
AD変換は各論理チャンネルを対象に実行します．
これは個別のチャンネルをソフトウェアからのコマンドで実行したり，有効化した全ての論理チャンネルの変換を一連のシーケンスとして単発，または継続的にループして実行できます．
さらに外部動機信号をトリガにした変換も可能．この機能を使えば，複数のAFEチップを同期させることも可能です．

複数の論理チャンネル変換シーケンスをループで実行すると，測定の自動化が可能です．変換後のデータは各論理チャンネルのレジスタに格納されているので，いつでも読み出すことができます．
変換完了をチャンネル毎，または一連のシーケンスとして完了したことを通知する信号出力を使えば，変換に同期したデータの読み出しも可能です．

## 自己診断機能
### ADでの各種電圧モニタ
どの入力ピンを選択するかは論理チャンネルで指定します．この切替を行うマルチプレクサには入力用のピンだけではなく，励起電圧・電流源，2種類のリファレンス電圧，さらにチップに供給されている電源電圧に切り替えることができます．
このような入力を論理チャンネルとして設定しAD変換シーケンスに組み込んでおけば，自身の動作状態を監視し続けることができます．
工場出荷時の校正データ入りのチップであれば，チップ出荷時のリファレンス電圧が不揮発性メモリエリアに書き込まれています．これを使えば製品組み立て時の問題や，経年変化の状態などもモニタすることが可能です．

### 入力の監視
論理チャンネルには信号の入力レンジを設定しておけます．これから外れた電圧が入力された場合，アラートが発生します．
入力部分では配線の断線が起こりえます．この監視用に65nAの励起電流原が用意されています．これを使った際の電圧をモニタすることによって，異常がないかをチェックできます．
あるいは断線まではいかなくてもケーブルの劣化が問題となることもあり得ます．このような場合にはインピーダンス変化の測定を行えば問題を発見できます．

### クロック源の監視
このNAFE13388では，起動時に外部クロック入力をチェックし，ない場合には水晶振動子での発振を試みます．それも不可能な場合は内部RC発信機でのクロックが作られます．
外部クロック，または水晶発振器でクロックが供給されている場合は，内部RC発振器によるクロックとの比較が行われ，異常があればアラートが発生します．

### 温度監視
NAFE13388では温度センサも内蔵．測定値のドリフト補正に使われるほか，チップ自身の保護のために規定の温度でのアラート，さらに高温時のシャットダウン保護機能も内蔵しています．

# 工場出荷時校正・ユーザによる校正
各PGAゲイン設定毎のゲインとオフセットの誤差はAD変換後のデジタル・ドメインで補正されます．この補正用の係数を保持しておくレジスタは16セット用意され，論理チャンネル毎にセットを指定できます．
工場出荷時校正されたNAFE13388であれば，各ゲイン設定時の補正係数があらかじめ用意されており，これを使えばユーザによる校正なしで+/-0.06%FS(typ値・室温)の精度が得られます．
この製品としてこの精度で充分であれば，手間と時間のかかる製品出荷時の校正作業が省けるため，大幅なコスト削減が可能になります．
この補正係数はユーザよる調整も可能です．ユーザによる校正を行えば精度を+/-0.002%FSまで向上させることができます．校正した係数は，論理チャンネルが指定したレジスタに設定しておけば自動的に補正されるため，読み出した値を後処理する必要はありません．
また補正係数を意図的に操作することにより，測定値を任意のレンジに調整するような使い方も可能になります．

